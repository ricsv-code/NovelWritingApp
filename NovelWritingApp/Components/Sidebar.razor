@using NovelWritingApp.Shared.Models
@using NovelWritingApp.Shared.Utilities
@inject ChapterService ChapterService
@inject CharacterService CharacterService

<div class="sidebar-container">
    @if (CurrentNovel != null)
    {
        <div class="column">
            <h2>Chapters</h2>
            <ul>
                @foreach (var chapter in CurrentNovel.Chapters)
                {
                    <li class="chapter-item @(chapter == SelectedChapter ? "selected" : "")">
                        <div class="chapter-header">
                            <span @onclick="() => SelectChapter(chapter)">@chapter.Title</span>
                            @if (chapter == SelectedChapter)
                            {
                                @if (!isEditingChapter)
                                {
                                    <button class="btn" @onclick="EditChapter">Edit</button>
                                }
                                else
                                {
                                    <button class="btn" @onclick="SaveChapter">Save</button>
                                    <button class="btn" @onclick="CancelEditChapter">Cancel</button>
                                }
                            }
                        </div>
                        @if (chapter == SelectedChapter)
                        {
                            <div class="chapter-details">
                                @if (!isEditingChapter)
                                {
                                    <p>@chapter.ChapSynopsis</p>
                                }
                                else
                                {
                                    <input type="text" @bind="chapter.Title" placeholder="Title" />
                                    <textarea @bind="chapter.ChapSynopsis" placeholder="Synopsis"></textarea>
                                }
                            </div>
                        }
                    </li>
                }
            </ul>
            <button class="btn" @onclick="CreateNewChapter">Create Chapter</button>
        </div>
        <div class="column">
            <h2>Characters</h2>
            <ul>
                @foreach (var character in CurrentNovel.Characters)
                {
                    <li class="character-item @(character == SelectedCharacter ? "selected" : "")">
                        <div class="character-header">
                            <span @onclick="() => SelectCharacter(character)">@character.Name</span>
                            @if (character == SelectedCharacter)
                            {
                                @if (!isEditingCharacter)
                                {
                                    <button class="btn" @onclick="EditCharacter">Edit</button>
                                }
                                else
                                {
                                    <button class="btn" @onclick="SaveCharacter">Save</button>
                                    <button class="btn" @onclick="CancelEditCharacter">Cancel</button>
                                }
                            }
                        </div>
                        @if (character == SelectedCharacter)
                        {
                            <div class="character-details">
                                @if (!isEditingCharacter)
                                {
                                    <p>@character.Description</p>
                                    <p>@character.Motivations</p>
                                    <p>@character.CharSynopsis</p>
                                }
                                else
                                {
                                    <input type="text" @bind="character.Name" placeholder="Name" />
                                    <textarea @bind="character.Description" placeholder="Description"></textarea>
                                    <textarea @bind="character.Motivations" placeholder="Motivations"></textarea>
                                    <textarea @bind="character.CharSynopsis" placeholder="Synopsis"></textarea>
                                }
                            </div>
                        }
                    </li>
                }
            </ul>
            <button class="btn" @onclick="CreateNewCharacter">Create Character</button>
        </div>
    }
</div>

@code {
    [Parameter] public Novel CurrentNovel { get; set; }
    [Parameter] public Chapter SelectedChapter { get; set; }
    [Parameter] public Character SelectedCharacter { get; set; }
    [Parameter] public EventCallback<Chapter> OnChapterSelected { get; set; }
    [Parameter] public EventCallback<Character> OnCharacterSelected { get; set; }
    [Parameter] public EventCallback OnCreateChapter { get; set; }
    [Parameter] public EventCallback OnCreateCharacter { get; set; }

    private bool isEditingChapter = false;
    private bool isEditingCharacter = false;

    private void SelectChapter(Chapter chapter)
    {
        SelectedChapter = chapter;
        isEditingChapter = false;
        OnChapterSelected.InvokeAsync(chapter);
    }

    private void EditChapter()
    {
        isEditingChapter = true;
    }

    private async Task SaveChapter()
    {
        isEditingChapter = false;
        CurrentNovel.LastModified = DateTime.Now;
        await ChapterService.UpdateChapterAsync(SelectedChapter.MapToDTO());
        Console.WriteLine("Chapter saved successfully.");
    }

    private void CancelEditChapter()
    {
        isEditingChapter = false;
    }

    private void SelectCharacter(Character character)
    {
        SelectedCharacter = character;
        isEditingCharacter = false;
        OnCharacterSelected.InvokeAsync(character);
    }

    private void EditCharacter()
    {
        isEditingCharacter = true;
    }

    private async Task SaveCharacter()
    {
        isEditingCharacter = false;
        CurrentNovel.LastModified = DateTime.Now;
        await CharacterService.UpdateCharacterAsync(SelectedCharacter.MapToDTO());
        Console.WriteLine("Character saved successfully.");
    }

    private void CancelEditCharacter()
    {
        isEditingCharacter = false;
    }

    private async Task CreateNewChapter()
    {
        await OnCreateChapter.InvokeAsync(null);
    }

    private async Task CreateNewCharacter()
    {
        await OnCreateCharacter.InvokeAsync(null);
    }
}
